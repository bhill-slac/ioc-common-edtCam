#! /usr/bin/env python

import sys
import logging
from PyQt4 import QtGui, QtCore, uic
from GigECamera import GigECamera


class DisplayImage(QtGui.QWidget):
    def __init__(self, parent, img):
        QtGui.QWidget.__init__(self, parent)
        self.parent = parent
        self.image = img
        self.img_width = 0
        self.img_height = 0
        self.data = None
        self.scaled_image = img
        self.painter = QtGui.QPainter()

    def paintEvent(self, event):
        self.setGeometry(QtCore.QRect(0, 0, self.parent.width(), self.parent.height()))
        self.image = QtGui.QImage(self.data, self.img_width, self.img_height, QtGui.QImage.Format_RGB32);
        if self.image and not self.image.isNull():
            self.scaled_image = self.image.scaled(self.width(), self.height(), aspectRatioMode = QtCore.Qt.KeepAspectRatio)
            self.painter.begin(self)
            x = ( self.width() - self.scaled_image.width() ) / 2
            y = ( self.height() - self.scaled_image.height() ) / 2
            self.painter.drawImage(x, y, self.scaled_image)
            self.painter.end()

    def setImage(self, img, width, height):
        self.data = img
        self.img_width = width
        self.img_height = height
        self.update()

class MyMainWindow(QtGui.QMainWindow):
    def __init__(self):
        super(MyMainWindow, self).__init__()
        self.ui = uic.loadUi('GigEViewer.ui')
        self.ui.closeEvent = self.closeEvent

        self.c = GigECamera(self.imageCaptured)
        self.c.connect('192.168.100.221')
        self.c.start()

        img = QtGui.QImage('img1.ppm')
        self.view = DisplayImage(self.ui.wImage, img)
        self.ui.show()

    def closeEvent(self, event):
        self.c.stop()
        self.c.disconnect()

    def imageCaptured(self, img, width, height):
        logging.debug("%s", repr(img))
        self.view.setImage(img, width, height)

if __name__ == '__main__':
    logging.basicConfig(\
        format='%(filename)s:%(lineno)d:%(levelname)-8s %(funcName)s: %(message)s',
        level=logging.INFO)   # DEBUG, INFO, ERROR, CRITICAL

    app = QtGui.QApplication(sys.argv)
    win = MyMainWindow()
    sys.exit(app.exec_())

