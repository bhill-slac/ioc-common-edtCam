#! /usr/bin/env python

import sys
import logging
from PyQt4 import QtGui, QtCore, uic
from GigECamera import GigECamera


class DisplayImage(QtGui.QWidget):
    def __init__(self, parent, img):
        QtGui.QWidget.__init__(self, parent)
        self.parent = parent
        self.image = img
        self.scaled_image = img
        self.painter = QtGui.QPainter()

    def paintEvent(self, event):
        self.setGeometry(QtCore.QRect(0, 0, self.parent.width(), self.parent.height()))
        self.painter.begin(self)
        x = ( self.width() - self.scaled_image.width() ) / 2
        y = ( self.height() - self.scaled_image.height() ) / 2
        self.painter.drawImage(x, y, self.scaled_image)
        self.painter.end()

    def resizeEvent(self, event):
        self.scaled_image = \
            self.image.scaled(self.width(), self.height(),
                              aspectRatioMode=QtCore.Qt.KeepAspectRatio)

class MyMainWindow(QtGui.QMainWindow):
    def __init__(self):
        # QtGui.QMainWindow.__init__(self)
        super(MyMainWindow, self).__init__()
        self.ui = uic.loadUi('GigEViewer.ui')
        self.ui.closeEvent = self.closeEvent

        # self.c = GigECamera(self.imageCaptured2)
        self.c = GigECamera(None)
        self.c.connect('192.168.100.221')
        self.c.start()

        img = QtGui.QImage('img1.ppm')
        DisplayImage(self.ui.wImage, img)
        self.ui.show()

    def __del__(self):
        # logging.info("%s", repr(img))
        # print 'Delete'
        pass

    def closeEvent(self, event):
        logging.info("")
        # event.ignore()
        self.c.stop()
        self.c.disconnect()

    def imageCaptured2(self, img):
        if logging:
            logging.info("%s", repr(img))
        else:
            print 'Logging gone!'

if __name__ == '__main__':
    logging.basicConfig(\
        format='%(filename)s:%(lineno)d:%(levelname)-8s %(funcName)s: %(message)s',
        level=logging.INFO)   # DEBUG, INFO, ERROR, CRITICAL

    app = QtGui.QApplication(sys.argv)
    win = MyMainWindow()
    ret = app.exec_()
    sys.exit(ret)

